#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# Copyright (c) 2024 hyperpolymath
# asdf-ada: Get the latest stable GNAT version

set -euo pipefail

# Get the plugin directory
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source utility functions
# shellcheck source=lib/utils.bash
source "${PLUGIN_DIR}/lib/utils.bash"

# Optional filter query (passed as first argument)
FILTER="${1:-}"

# Main
check_dependencies

if [[ -n "${FILTER}" ]]; then
  # Apply filter BEFORE selecting latest (e.g., "14" matches 14.x.x versions)
  # Get all versions, filter by prefix, exclude snapshots, sort descending, take first
  list_all_versions | tr ' ' '\n' | grep -E "^${FILTER}" | grep -v "snapshot" | \
    sort -t. -k1,1rn -k2,2rn -k3,3rn | head -1
else
  get_latest_stable
fi
